
services:
  pg:
    image: postgres:17
    platform: linux/amd64
    environment:
      # Support all ENV_STATE values: DEV_, PROD_, TEST_
      # Uses DEV_ prefix by default, falls back to unprefixed if not set
      POSTGRES_DB: ${DEV_POSTGRESQL_DATABASE:-${PROD_POSTGRESQL_DATABASE:-${TEST_POSTGRESQL_DATABASE:-${POSTGRESQL_DATABASE:-mydb}}}}
      POSTGRES_USER: ${DEV_POSTGRESQL_USERNAME:-${PROD_POSTGRESQL_USERNAME:-${TEST_POSTGRESQL_USERNAME:-${POSTGRESQL_USERNAME:-postgres}}}}
      POSTGRES_PASSWORD: ${DEV_POSTGRESQL_PASSWORD:-${PROD_POSTGRESQL_PASSWORD:-${TEST_POSTGRESQL_PASSWORD:-${POSTGRESQL_PASSWORD:-secret}}}}
    ports:
      - "${DEV_POSTGRESQL_PORT:-${PROD_POSTGRESQL_PORT:-${TEST_POSTGRESQL_PORT:-${POSTGRESQL_PORT:-5432}}}}:5432"
    volumes:
      - pg-data:/var/lib/postgresql/data
    networks:
      - backend

  pgadmin:
    image: dpage/pgadmin4
    ports:
      - 8090:80
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL:-admin@example.com}
      PGADMIN_DEFAULT_PASSWORD: ${DEV_POSTGRESQL_PASSWORD:-${PROD_POSTGRESQL_PASSWORD:-${TEST_POSTGRESQL_PASSWORD:-${POSTGRESQL_PASSWORD:-secret}}}}
      PGADMIN_CONFIG_SERVER_MODE: "False"  # for local dev, to avoid CSRF issues
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    depends_on:
      - pg
    networks:
      - backend

  backend:
    build: .
    environment:
      # Pass ENV_STATE to the application
      ENV_STATE: ${ENV_STATE:-dev}
      # Support all ENV_STATE values with appropriate prefixes
      # The application will read the prefixed variables based on ENV_STATE
      DEV_POSTGRESQL_USERNAME: ${DEV_POSTGRESQL_USERNAME:-}
      DEV_POSTGRESQL_PASSWORD: ${DEV_POSTGRESQL_PASSWORD:-}
      DEV_POSTGRESQL_SERVER: ${DEV_POSTGRESQL_SERVER:-pg}
      DEV_POSTGRESQL_PORT: ${DEV_POSTGRESQL_PORT:-5432}
      DEV_POSTGRESQL_DATABASE: ${DEV_POSTGRESQL_DATABASE:-}
      PROD_POSTGRESQL_USERNAME: ${PROD_POSTGRESQL_USERNAME:-}
      PROD_POSTGRESQL_PASSWORD: ${PROD_POSTGRESQL_PASSWORD:-}
      PROD_POSTGRESQL_SERVER: ${PROD_POSTGRESQL_SERVER:-pg}
      PROD_POSTGRESQL_PORT: ${PROD_POSTGRESQL_PORT:-5432}
      PROD_POSTGRESQL_DATABASE: ${PROD_POSTGRESQL_DATABASE:-}
      TEST_POSTGRESQL_USERNAME: ${TEST_POSTGRESQL_USERNAME:-}
      TEST_POSTGRESQL_PASSWORD: ${TEST_POSTGRESQL_PASSWORD:-}
      TEST_POSTGRESQL_SERVER: ${TEST_POSTGRESQL_SERVER:-pg}
      TEST_POSTGRESQL_PORT: ${TEST_POSTGRESQL_PORT:-5432}
      TEST_POSTGRESQL_DATABASE: ${TEST_POSTGRESQL_DATABASE:-}
      # Other environment variables
      DOMAIN: ${DOMAIN:-localhost}
      BACKEND_CORS_ORIGINS: ${BACKEND_CORS_ORIGINS:-}
      DEV_JWT_SECRET_KEY: ${DEV_JWT_SECRET_KEY:-}
      DEV_JWT_ALGORITHM: ${DEV_JWT_ALGORITHM:-}
      DEV_ACCESS_TOKEN_EXPIRE_MINUTES: ${DEV_ACCESS_TOKEN_EXPIRE_MINUTES:-}
      DEV_MAILGUN_API_KEY: ${DEV_MAILGUN_API_KEY:-}
      DEV_MAILGUN_DOMAIN: ${DEV_MAILGUN_DOMAIN:-}
      DEV_LOGTAIL_API_KEY: ${DEV_LOGTAIL_API_KEY:-}
      PROD_JWT_SECRET_KEY: ${PROD_JWT_SECRET_KEY:-}
      PROD_JWT_ALGORITHM: ${PROD_JWT_ALGORITHM:-}
      PROD_ACCESS_TOKEN_EXPIRE_MINUTES: ${PROD_ACCESS_TOKEN_EXPIRE_MINUTES:-}
      PROD_MAILGUN_API_KEY: ${PROD_MAILGUN_API_KEY:-}
      PROD_MAILGUN_DOMAIN: ${PROD_MAILGUN_DOMAIN:-}
      PROD_LOGTAIL_API_KEY: ${PROD_LOGTAIL_API_KEY:-}
      TEST_JWT_SECRET_KEY: ${TEST_JWT_SECRET_KEY:-}
      TEST_JWT_ALGORITHM: ${TEST_JWT_ALGORITHM:-}
      TEST_ACCESS_TOKEN_EXPIRE_MINUTES: ${TEST_ACCESS_TOKEN_EXPIRE_MINUTES:-}
      TEST_MAILGUN_API_KEY: ${TEST_MAILGUN_API_KEY:-}
      TEST_MAILGUN_DOMAIN: ${TEST_MAILGUN_DOMAIN:-}
      TEST_LOGTAIL_API_KEY: ${TEST_LOGTAIL_API_KEY:-}
    ports:
      - "8000:8000"
    depends_on:
      - pg
    networks:
      - backend

  alembic:
    image: python:3.12
    working_dir: /app
    volumes:
      - ./:/app
    depends_on:
      - pg
    environment:
      ENV_STATE: ${ENV_STATE:-dev}
      # Pass all prefixed variables for Alembic
      DEV_POSTGRESQL_USERNAME: ${DEV_POSTGRESQL_USERNAME:-}
      DEV_POSTGRESQL_PASSWORD: ${DEV_POSTGRESQL_PASSWORD:-}
      DEV_POSTGRESQL_SERVER: ${DEV_POSTGRESQL_SERVER:-pg}
      DEV_POSTGRESQL_PORT: ${DEV_POSTGRESQL_PORT:-5432}
      DEV_POSTGRESQL_DATABASE: ${DEV_POSTGRESQL_DATABASE:-}
      PROD_POSTGRESQL_USERNAME: ${PROD_POSTGRESQL_USERNAME:-}
      PROD_POSTGRESQL_PASSWORD: ${PROD_POSTGRESQL_PASSWORD:-}
      PROD_POSTGRESQL_SERVER: ${PROD_POSTGRESQL_SERVER:-pg}
      PROD_POSTGRESQL_PORT: ${PROD_POSTGRESQL_PORT:-5432}
      PROD_POSTGRESQL_DATABASE: ${PROD_POSTGRESQL_DATABASE:-}
      TEST_POSTGRESQL_USERNAME: ${TEST_POSTGRESQL_USERNAME:-}
      TEST_POSTGRESQL_PASSWORD: ${TEST_POSTGRESQL_PASSWORD:-}
      TEST_POSTGRESQL_SERVER: ${TEST_POSTGRESQL_SERVER:-pg}
      TEST_POSTGRESQL_PORT: ${TEST_POSTGRESQL_PORT:-5432}
      TEST_POSTGRESQL_DATABASE: ${TEST_POSTGRESQL_DATABASE:-}
    networks:
      - backend
    command: >
      bash -c "
      pip install -q -r requirements.txt &&
      until pg_isready -h pg -p 5432; do sleep 1; done &&
      python -m alembic upgrade head
      "

volumes:
  pg-data:
    driver: local
  pgadmin-data:
    driver: local

networks:
  backend:
    driver: bridge
